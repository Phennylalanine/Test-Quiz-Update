// --- Game Variables ---
let currentChar = '';
let currentLevel = 1; // Only Level 1 remains

let score = 0;
let combo = 0;
let answered = false;

const keys = 'abcdefghijklmnopqrstuvwxyz'.split('');
const keyMap = {};
keys.forEach(k => keyMap[k] = 'key-' + k);

// DOM Elements
const letterDisplay = document.getElementById("letterDisplay");
const pointsEl = document.getElementById("points");
const comboEl = document.getElementById("combo");
const levelEl = document.getElementById("level");
const confettiCanvas = document.getElementById("confettiCanvas");
const ctx = confettiCanvas.getContext("2d");

let confettiParticles = [];

const startBtn = document.getElementById("startBtn");

// Level select logic (only Level 1)
document.querySelectorAll(".level-select").forEach(button => {
  button.addEventListener("click", () => {
    selectLevel(1);
  });
});

// Start button logic
startBtn.addEventListener("click", () => {
  document.getElementById("startScreen").classList.remove("active");
  document.getElementById("gameScreen").classList.add("active");
  startGame(1);
});

// Keyboard input listener
window.addEventListener("keydown", (e) => {
  if (!currentChar) return;
  const pressedKey = e.key.toLowerCase();
  const targetKey = currentChar.toLowerCase();
  if (pressedKey === targetKey) {
    handleCorrectAnswer();
  } else if (keys.includes(pressedKey)) {
    combo = 0;
    score = Math.max(0, score - 1);
    updateStats();
    flashWrongKey();
  }
});

// Functions

function flashWrongKey() {
  letterDisplay.classList.add("flash-wrong");
  setTimeout(() => {
    letterDisplay.classList.remove("flash-wrong");
  }, 200);
}

function selectLevel(level) {
  currentLevel = 1;
  startBtn.disabled = false;
  document.querySelectorAll(".level-select").forEach(btn => btn.classList.remove("selected"));
  document.querySelectorAll(".level-select")[0].classList.add("selected");
}

function startGame(levelNumber) {
  currentLevel = 1;
  currentChar = '';
  score = 0;
  combo = 0;
  answered = false;
  updateStats();
  nextChar();
}

function nextChar() {
  removeHighlight();
  currentChar = keys[Math.floor(Math.random() * keys.length)];
  letterDisplay.textContent = currentChar.toUpperCase();
  speak(currentChar);
  highlightKey(currentChar);
}

function highlightKey(char) {
  removeHighlight();
  const id = keyMap[char.toLowerCase()];
  const el = document.getElementById(id);
  if (el) el.classList.add('highlight');
}

function removeHighlight() {
  document.querySelectorAll('.key').forEach(el => el.classList.remove('highlight'));
}

function handleCorrectAnswer() {
  combo++;
  score++;
  updateStats();
  nextChar();
}

function updateStats() {
  pointsEl.textContent = score;
  comboEl.textContent = combo;
  levelEl.textContent = currentLevel;
}

function speak(text) {
  if ('speechSynthesis' in window) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    speechSynthesis.speak(utter);
  }
}

// Confetti functions
function triggerConfetti() {
  for (let i = 0; i < 100; i++) {
    confettiParticles.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * -20,
      r: Math.random() * 6 + 2,
      d: Math.random() * 12.5 + 1,
      color: `hsl(${Math.floor(Math.random() * 360)}, 100%, 70%)`,
      tilt: Math.random() * 10 - 10,
    });
  }
}

function drawConfetti() {
  ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
  confettiParticles.forEach((p) => {
    ctx.beginPath();
    ctx.fillStyle = p.color;
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fill();
  });
  updateConfetti();
}

function updateConfetti() {
  for (let i = 0; i < confettiParticles.length; i++) {
    const p = confettiParticles[i];
    p.y += p.d;
    p.x += Math.sin(p.tilt) * 2;
    if (p.y > confettiCanvas.height) {
      confettiParticles.splice(i, 1);
      i--;
    }
  }
}

function resizeCanvas() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();
setInterval(drawConfetti, 30);
